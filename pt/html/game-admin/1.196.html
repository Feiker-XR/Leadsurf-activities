<!DOCTYPE HTML>
<html lang="en-US" class="html-content">
<head>
	<meta charset="UTF-8">
	<title>修改变价方案  封锁数据</title>
	<link rel="stylesheet" href="../images/common/base.css" />
    <link rel="stylesheet" href="../images/common/js-ui.css" />
	<link rel="stylesheet" href="../images/admin/admin.css" />

	<style>
	.table-params {width:300px;display:inline-block;}
	.table-params th {text-align:center;background:#F1F1F1;}
	.table-params .table-align-right {text-align:right;}
								
	.table-cont {padding:10px;}
	.table-chart {display:inline-block;width:800px;}
	.table-chart th {font-weight:bold;background:#F1F1F1;}
	
	.chart-cont {width:600px;height:357px;display:inline-block;}
	.chart-tip {position:absolute;left:0;top:2px;z-index:500;background:#FFF;border:1px solid #CCC;padding:5px;line-height:150%;display:none;}
	
	.input {color:#F00;}
	
	.table-chart tr:hover td {background:#FFFFE1;}
	</style>
    <script type="text/javascript" src="../js/jquery-1.9.1.min.js"></script>
	<script type="text/javascript" src="../js/jquery.tmpl.min.js"></script>
	<script type="text/javascript" src="../js/phoenix.base.js"></script>
	<script type="text/javascript" src="../js/phoenix.Class.js"></script>
	<script type="text/javascript" src="../js/phoenix.Event.js"></script>
	<script type="text/javascript" src="../js/phoenix.util.js"></script>
	<script type="text/javascript" src="../js/phoenix.Mask.js"></script>
	<script type="text/javascript" src="../js/phoenix.DatePicker.js"></script>
	<script type="text/javascript" src="../js/phoenix.SuperSearchGroup.js"></script>
	<script type="text/javascript" src="../js/phoenix.SuperSearch.js"></script>
	<script type="text/javascript" src="../js/phoenix.Tab.js"></script>
	<script type="text/javascript" src="../js/phoenix.MiniWindow.js"></script>
	
	<script type="text/javascript" src="../js/jquery.flot.js"></script>
	<script type="text/javascript" src="../js/jquery.flot.crosshair.js"></script>

	
</head>
<body>



	<div class="menu">
		<div class="menu-logo"></div>
		<ul class="menu-list">
			<li><a href="">首页</a></li>
			<li><a href="">全局</a></li>
			<li><a href="">用户</a></li>
			<li class="current"><a href="">游戏</a></li>
			<li><a href="">资金</a></li>
			<li><a href="">市场促销</a></li>
			<li><a href="">统计</a></li>
			<li><a href="">内容</a></li>
			<li><a href="">权限</a></li>
		</ul>
		<div class="menu-quit"><a href="">退出</a><i class="ico-user"></i>你好，vava</div>
	</div>
	<div class="col-content">
		<div class="col-side">
			<dl class="nav">
				<dt>彩种管理</dt>
				<dd class="current"><a href="">彩种信息列表</a></dd>
				<dt>奖期流程管理</dt>
				<dd><a href="">流程监控</a></dd>
				<dd><a href="#">异常流程记录</a></dd>
				<dt>方案&追号管理</dt>
				<dd><a href="#">方案记录</a></dd>
				<dd><a href="#">追号记录</a></dd>
				<dd><a href="#">异常记录</a></dd>
				<dt>报表管理</dt>
				<dd><a href="#">单期盈亏表</a></dd>
			</dl>
		</div>
		<div class="col-main">
			<div class="col-crumbs"><div class="crumbs"></div></div>
			<div class="col-content">
				<div class="col-main">
					<div class="main">
						<div class="ui-tab">
							<div class="ui-tab-title clearfix">
								<ul>
									<li><a href="1.11.html">奖期规则</a></li>
									<li><a href="1.12.html">奖金组</a></li>
									<li><a href="1.13.html">投注限制</a></li>
									<li><a href="1.171.html">封锁</a></li>
									<li class="current"><a href="1.191.html">变价</a></li>
									<li><a href="1.14.html">玩法描述</a></li>
									<li><a href="1.15.html">销售状态</a></li>
									<li><a href="1.16.html">参数设置</a></li>
								</ul>
							</div>
							<div class="ui-tab-content" id="J-list-container">
							
								<ul class="ui-tab-title clearfix">
									<li class="current"><a href="1.191.html">变价</a></li>
									<li><a href="1.192.html">变价参数设定</a></li>
								</ul>
								
								<h3 class="ui-title">
									<a href="1.191.html">&lt;&lt;返回变价方案列表</a>
									&nbsp;&nbsp;&nbsp;&nbsp;
									修改方案
								</h3>
								
								<form id="J-form" action="?">
								<h3 class="ui-title">
									变价方案名称:
									<input type="text" class="input w-5" style="color:#666;" value="3D变价方案" />
									<input id="J-input-value-up" name="param-up" type="hidden" value="" />
									<input id="J-input-value-down" name="param-down" type="hidden" value="" />
								</h3>
								</form>
								
								
								

								<div class="table-cont" style="display:none;">
									<table class="table table-border table-params">
										<tr>
											<th colspan="2"><b>向上变价参数</b></th>
										</tr>
										<tr>
											<td class="table-align-right">默认奖金值：</td>
											<td>1,700.00/1,500.00</td>
										</tr>
										<tr>
											<td class="table-align-right">向下变价极限值：</td>
											<td><span class="color-red">1,000.00</span></td>
										</tr>
										<tr>
											<td class="table-align-right">变价阶段数目：</td>
											<td>5</td>
										</tr>
									</table>
								
								
									<table class="table table-border table-params">
										<tr>
											<th colspan="2"><b>向下变价参数</b></th>
										</tr>
										<tr>
											<td class="table-align-right">默认奖金值：</td>
											<td>1,700.00/1,500.00</td>
										</tr>
										<tr>
											<td class="table-align-right">向下变价极限值：</td>
											<td><span class="color-red">1,000.00</span></td>
										</tr>
										<tr>
											<td class="table-align-right">变价阶段数目：</td>
											<td>5</td>
										</tr>
									</table>
								</div>
								
								
								<div class="table-cont">
									<table data-type="up" class="table table-border table-chart" border="0" cellspacing="0" cellpadding="0">
									<tbody id="J-table-chart-up">
									</tbody>
									</table>
									<div id="J-chart-up" class="chart-cont"></div>
								</div>
								
								
								
								<div class="table-cont">
									<table data-type="down" class="table table-border table-chart" border="0" cellspacing="0" cellpadding="0">
									<tbody id="J-table-chart-down">
										
									</tbody>
									</table>
									<div id="J-chart-down" class="chart-cont"></div>
								</div>
						
						
								
								<div class="page-wrapper clearfix" style="padding:10px">
									<a class="btn btn-important" href="#" id="J-button-submit">保 存<b class="btn-inner"></b></a>
									&nbsp;&nbsp;
									<a class="btn" href="#" id="J-button-reset">重 置<b class="btn-inner"></b></a>
								</div>
								
								
						
								<div style="height:200px;"></div>
								
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
	</div>
	

<div id="J-chart-tip" class="chart-tip"></div>







	
	
	
<script>



//后台的同学，以下内容需要你们提供
//玩法是可以随意增加的，只要有相关配置

	//baseMoney 理论奖金
	//cfgMoney 平台设置奖金
	//downMinMoney 向下变价极限值
	//profit 向上变价留水值
	var gameConfig = {
		baseMoney:2000,
		downMinMoney:1000,
		profit:-0.05
	};
	var headData = [
		{title:'1500奖金组奖金示例', group:[{title:'直选', baseMoney:2000, cfgMoney:1500}, {title:'组三', baseMoney:667, cfgMoney:500}, {title:'组六', baseMoney:333, cfgMoney:250}]}, 
		{title:'1700奖金组奖金示例', group:[{title:'直选', baseMoney:2000, cfgMoney:1700}, {title:'组三', baseMoney:667, cfgMoney:570}, {title:'组六', baseMoney:333, cfgMoney:280}]}
	];
	var upData = [];
	var downData = [];
	//[[开始金额, 结束金额], 变价率]
	upData.push([[800000,1000000], 100]);
	upData.push([[600000,800000], 80]);
	upData.push([[400000,600000], 60]);
	upData.push([[200000,400000], 40]);
	upData.push([[100000,200000], 20]);
	upData.push([[0,100000], 0]);
	
	downData.push([[0,-100000], 0]);
	downData.push([[-100000,-200000], 20]);
	downData.push([[-200000,-400000], 40]);
	downData.push([[-400000,-600000], 60]);
	downData.push([[-600000,-800000], 80]);
	downData.push([[-800000,-1000000], 100]);
	
//后台的同学，以上内容需要你们提供	


	
	
</script>

<script>
(function($){
	//根据后台数据生成表格
	var PriceTable = function(cfg){
		this.cfg = cfg;
		this.init(cfg);
	};
	PriceTable.prototype.init = function(cfg){
		var me = this;
		me.gameConfig = cfg.gameConfig;
		me.type = cfg.type;
		me.tableCont = $(cfg.tableCont);
		me.headData = cfg.headData;
		me.data = cfg.data;
		me.initDom();
	};
	PriceTable.prototype.initDom = function(){
		var me = this,
			data = me.data,
			groupLen = me.headData.length,
			i = 0,
			j = 0,
			k = 0,
			len2,
			len3,
			tdStr = [],
			space = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
			dataObj = null,
			thStr = ['<tr><th rowspan="2">变价阶段</th><th rowspan="2">浮动盈亏值</th><th rowspan="2">变价率</th>'];
		//生成表头
		for(i = 0;i < groupLen;i++){
			thStr.push('<th colspan="'+ me.headData[i]['group'].length +'">'+ me.headData[i]['title'] +'</th>');
		}
		thStr.push('<th rowspan="2">操作</th></tr>');
		thStr.push('<tr>');
		for(i = 0;i < groupLen;i++){
			len2 = me.headData[i]['group'].length;
			for(j = 0;j < len2;j++){
				thStr.push('<th>'+ me.headData[i]['group'][j]['title'] +'</th>');
			}
		}
		thStr.push('</tr>');
		me.tableCont.append($(thStr.join('')));
		
		
		//生成内容
		for(i = 0, len2 = data.length; i < len2; i++){
			tdStr = [];
			tdStr.push('<tr class="tr-row"><td><span class="row-step">'+ (me.type == 'up' ? len2 - i : (i+1)) +'阶段</span></td><td><span class="money-start">'+ (data[i][0][0].toFixed(2) == 0.00 ? space : '')  + data[i][0][0].toFixed(2) +'</span> 至 <input type="text" class="input-minmoney input w-2" value="'+ data[i][0][1].toFixed(2) +'"></td><td><input type="text" class="input-perc input w-1" value="'+ data[i][1] +'"> %</td>');
				for(j = 0; j < groupLen; j++){
					//玩法奖金
					len3 = me.headData[j]['group'].length;
					for(k = 0; k < len3; k++){
						dataObj = me.headData[j]['group'][k];
						tdStr.push('<td class="td-money-prize">'+ Math.round(me.getMoney(dataObj, data[i][1])) +'</td>');
					}
				}
			tdStr.push('<td><a data-action="add" href="#">增加</a><br><a data-action="del" href="#">删除</a></td></tr>');
			me.tableCont.append($(tdStr.join('')));
		}
	};
	//神奇的变价方案计算公式
	//baseMax 全额奖金
	//baseMin 向下变价极限值
	//profit 公司流水
	//perc 变价率
	PriceTable.prototype.getMoney = function(dataObj, perc){
		var me = this,
			type = me.type,
			baseMax,
			baseMin;
		//向上变价
		if(type == 'up'){
			baseMax = dataObj['cfgMoney'];
			baseMin = dataObj['baseMoney'] * (1 - me.gameConfig['profit']);
			return baseMax*(1 - (baseMax-baseMin)/baseMax*perc/100);
		}else{
		//向下变价
			baseMax = dataObj['cfgMoney'];
			baseMin = me.gameConfig['downMinMoney']/me.gameConfig['baseMoney'] * dataObj['baseMoney'];
			return baseMax*(1 - (baseMax-baseMin)/baseMax*perc/100);
		}
	}
	
	var priceTableUp = new PriceTable({type:'up', gameConfig:gameConfig, tableCont:'#J-table-chart-up', headData:headData, data:upData});
	var priceTableDown = new PriceTable({type:'down', gameConfig:gameConfig, tableCont:'#J-table-chart-down', headData:headData, data:downData});


	
	
	
	
	
	
	//
	var ChangePriceGroup = function(cfg){
		this.cfg = cfg;
		this.init();
	};
	ChangePriceGroup.chartOptions = {
		series: {
			bars: {
				show: true,
				barWidth: 20,
				align: "center",
				lineWidth:0
			}
		},
		lines: {
			show: true,
			lineWidth: 2
		},
		colors: ["#009ED0"],
		points: {
			show: true
		},
		xaxis: {
			tickSize: 5,
		},
		yaxis: {
			tickSize: 10
		},
		grid: {
			borderWidth: 1,
			color: '#999',
			hoverable: true,
			autoHighlight: true
		},
		legend: {
			color: '#000'
		}
	};
	ChangePriceGroup.prototype.init = function(){
		var me = this;
		me.priceTable = me.cfg.priceTable;
		me.type = me.cfg.type;
		me.table = $(me.cfg.table);
		me.chartCont = $(me.cfg.chartCont);
		me.data = null
		me.plot = null;
		me.tip = $('#J-chart-tip');
		me.chartData = {"data":[]};
		me.setData(me.cfg.data);
		me.showChart();
		me.initEvent();
	};
	ChangePriceGroup.prototype.setData = function(data){
		var me = this;
		me.data = data;
		me.chartData = {"data":[]};
		$.each(me.data, function(){
			me.chartData['data'].push([this[0][0]/10000, this[1]]);
		});
	};
	ChangePriceGroup.prototype.showChart = function(){
		var me = this;
		if(me.type == 'up'){
			ChangePriceGroup.chartOptions.series.bars.align = 'left';
		}else{
			ChangePriceGroup.chartOptions.series.bars.align = 'right';
		}
		me.chartCont.html('');
		me.plot = $.plot(me.chartCont, [me.chartData], ChangePriceGroup.chartOptions);
	};
	ChangePriceGroup.prototype.initEvent = function(){
		var me = this;
		me.chartCont.bind('plothover', function(e, pos, it){
			if (it) {
				//console.log(it.dataIndex);
				var x = it.datapoint[0].toFixed(2),
					y = it.datapoint[1].toFixed(2);
				me.tip.html('浮动盈亏: ' + x + '万至' + (me.data[it.dataIndex][0][1]/10000).toFixed(2) + '万<br/>变价率: ' + y + '%' )
					.css({top: it.pageY - 55, left: it.pageX+5})
					.fadeIn(200);
			} else {
				me.tip.hide();
			}
		});
		me.table.on('click', '[data-action]', function(e){
			e.preventDefault();
			var el = $(this),action = $.trim(el.attr('data-action'));
			switch(action){
				case 'add':
					me.addRow(el.parent().parent());
				break;
				case 'del':
					me.delRow(el.parent().parent());
				break;
				default:
				break;
			}
		});
		me.table.on('blur', '.input-minmoney', function(){
			var el = $(this);
		});
		
	};
	ChangePriceGroup.prototype.addRow = function(tr){
		var me = this,
			i = 0,
			trs,
			index,
			size,
			headData = me.priceTable.headData,
			//[[开始金额, 结束金额], 变价率]
			newData = [[0, 0], 0],
			newRow = $('<tr class="tr-row">'+ tr.html() +'</tr>');
			newTds = newRow.find('.td-money-prize');
		
		i = 0;
		$.each(headData, function(){
			var group = this['group'];
			$.each(group, function(){
				newTds.eq(i).text(Math.round(me.priceTable.getMoney(this, newData[1])));
				i++;
			});
		});
			
		newData[0][0] = Number(tr.find('.input-minmoney').val()).toFixed(2);
		
		newRow.find('.money-start').text(newData[0][0]);
		newRow.find('.input-minmoney').val(newData[0][1]);
		newRow.find('.input-perc').val(newData[1]);
		if(me.type == 'up'){
			newRow.insertBefore(tr);
		}else{
			newRow.insertAfter(tr);
		}
		trs = me.table.find('.tr-row');
		index = trs.index(newRow.get(0));
		me.data.splice(index, 0, newData);
		me.setData(me.data);
		me.showChart();
		//console.log(me.data);
		
		size = trs.size();
		trs.each(function(i){
			$(this).find('.row-step').text((me.type == 'up' ? size - i : (i+1)) + '阶段');
		});
	};
	ChangePriceGroup.prototype.delRow = function(tr){
		var me = this,
			trs = me.table.find('.tr-row'),
			index = trs.index(tr);
		if(trs.size() >= 2){
			tr.remove();
			me.data.splice(index, 1);
			me.setData(me.data);
			me.showChart();
		}
	};
	
	
	var chartGroupUp = new ChangePriceGroup({type:'up', table:'#J-table-chart-up', chartCont:'#J-chart-up', data:upData, priceTable:priceTableUp});
	var chartGroupDown = new ChangePriceGroup({type:'down', table:'#J-table-chart-down', chartCont:'#J-chart-down', data:downData, priceTable:priceTableDown});
	
	
	
	$('.table-chart').on('keyup', '.input-perc', function(e){
		var v = $.trim(this.value);
		v = v.replace(/[^\d|\-|\.]/g, '');
		this.value = v;
	});
	$('.table-chart').on('blur', '.input-perc', function(e){
		var el = $(this),v = el.val().replace(/[^\d|\-|\.]/g, ''),tr = el.parents('.tr-row'),table = el.parents('.table-chart'),trs = table.find('.tr-row'),
			type = $.trim(table.attr('data-type')),
			i = 0,
			headData,
			chartObj,
			prizeDoms,
			index = trs.index(tr.get(0));
			v = Number(v);
		if(type == 'up'){
			chartObj = chartGroupUp;
		}else{
			chartObj = chartGroupDown;
		}
		
		prizeDoms = tr.find('.td-money-prize');
		i = 0;
		headData = chartObj.priceTable.headData
		$.each(headData, function(){
			var group = this['group'];
			$.each(group, function(){
				prizeDoms.eq(i).text(Math.round(chartObj.priceTable.getMoney(this, v)));
				i++;
			});
		});
		
		chartObj['data'][index][1] = v;
		el.val(v);
		chartObj.setData(chartObj['data']);
		chartObj.showChart();
	});
	$('.table-chart').on('blur', '.input-minmoney', function(e){
		var el = $(this),v = el.val().replace(/[^\d|\-|\.]/g, ''),tr = el.parents('.tr-row'),table = el.parents('.table-chart'),trs = table.find('.tr-row'),
			type = $.trim(table.attr('data-type')),
			preTr,
			preLimitMoneyDom,
			limitMoney,
			chartObj,
			index = trs.index(tr.get(0));
			
			v = Number(v).toFixed(2);
			el.val(v);

		if(type == 'up'){
			chartObj = chartGroupUp;
			chartObj['data'][index][0][1] = v;
			if(index != 0){
				chartObj['data'][index - 1][0][0] = v;
			}
			preTr = trs.eq(index - 1);
			preLimitMoneyDom = preTr.find('.money-start');
			limitMoney = Number(preLimitMoneyDom.text());
			if(v >= limitMoney){
				preLimitMoneyDom.text(v);
			}
		}else{
			chartObj = chartGroupDown;
			chartObj['data'][index][0][1] = v;
			if(index != (trs.size() - 1)){
				chartObj['data'][index + 1][0][0] = v;
			}
			preTr = trs.eq(index + 1);
			preLimitMoneyDom = preTr.find('.money-start');
			limitMoney = Number(preLimitMoneyDom.text());
			if(v <= limitMoney){
				preLimitMoneyDom.text(v);
			}
		}
		
		chartObj.setData(chartObj['data']);
		chartObj.showChart();
		
	});
	
	
	$('#J-button-reset').click(function(e){
		e.preventDefault();
		location.href = location.href;
	});
	
	
	$('#J-button-submit').click(function(e){
		e.preventDefault();
		var old = null,
			isPass = true;
		
		//校验向上变价数据
		$.each(upData, function(){
			if(old){
				if(old[0][0] < this[0][1]){
					isPass = false;
					return false;
				}
			}
			old = this;
			if(this[0][0] > this[0][1]){
				isPass = false;
				alert('向上变价中开始金额不能大于结束金额:\n\n' + Number(this[0][0]).toFixed(2) + '至' + Number(this[0][1]).toFixed(2) + '\n\n变价率：' + this[1] + '%');
				return false;
			}
		});
		
		//校验向下变价
		old = null;
		$.each(downData, function(){
			if(old){
				if(old[0][1] < this[0][0]){
					isPass = false;
					return false;
				}
			}
			old = this;
			if(this[0][0] < this[0][1]){
				isPass = false;
				alert('向下变价中开始金额不能小于结束金额:\n\n' + Number(this[0][0]).toFixed(2) + '至' + Number(this[0][1]).toFixed(2) + '\n\n变价率：' + this[1] + '%');
				return false;
			}
		});
		
		
		if(isPass){
			$('#J-input-value-up').val(upData.join('|'));
			$('#J-input-value-down').val(downData.join('|'));
			$('#J-form').submit();
		}
	});
	
	
})(jQuery);
</script>














</body>
</html>